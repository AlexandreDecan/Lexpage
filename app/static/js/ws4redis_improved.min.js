// Taken from django-websocket-redis/ws4redis/static/js/ws4redis.js
// License: MIT
function WS4RedisImproved(e,n){"use strict"
function o(e){try{f=n.Deferred(),u=new WebSocket(e),u.onopen=r,u.onmessage=a,u.onerror=c,u.onclose=s,d=null}catch(o){f.reject(new Error(o))}}function t(){try{if(v++,v>3)throw new Error("Too many missed heartbeats.")
u.send(l.heartbeat_msg)}catch(e){clearInterval(h),h=null,console.warn("Closing connection. Reason: "+e.message),u.close()}}function r(){"function"==typeof l.on_open&&l.on_open(),f.resolve(),l.heartbeat_msg&&null===h&&(v=0,h=setInterval(t,5e3))}function s(e){if("function"==typeof l.on_close&&l.on_close(e.data),!d){var n=i(m)
d=setTimeout(function(){m++,o(u.url)},n)}}function c(e){console.error("Websocket connection is broken!"),f.reject(new Error(e)),"function"==typeof l.on_error&&l.on_error(e.data)}function a(e){if(l.heartbeat_msg&&e.data===l.heartbeat_msg)v=0
else if("function"==typeof l.receive_message)return l.receive_message(e.data)}function i(e){var n=1e3*(Math.pow(2,e)-1)
return n>3e4&&(n=3e4),Math.random()*n}var l,u,f,d,m=1,h=null,v=0
if(void 0===this)return new WS4RedisImproved(e,n)
if(void 0===e.uri)throw new Error("No Websocket URI in options")
void 0===n&&(n=jQuery),l=n.extend({heartbeat_msg:null},e),o(l.uri),this.reconnect=function(){m=1,d&&clearInterval(d)
try{u.close()}catch(e){console.log("could not close ws:"+e.message)}o(u.url+"&r")},this.send_message=function(e){u.send(e)}}