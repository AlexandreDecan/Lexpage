// Taken from django-websocket-redis/ws4redis/static/js/ws4redis.js
// License: MIT
function WS4RedisImproved(e,n){"use strict"
function o(e){try{console.log("Connecting to "+e+" ..."),f=n.Deferred(),u=new WebSocket(e),u.onopen=r,u.onmessage=i,u.onerror=c,u.onclose=s,d=null}catch(o){f.reject(new Error(o))}}function t(){try{if(h++,h>3)throw new Error("Too many missed heartbeats.")
u.send(l.heartbeat_msg)}catch(e){clearInterval(g),g=null,console.warn("Closing connection. Reason: "+e.message),u.close()}}function r(){console.log("Connected!"),"function"==typeof l.on_open&&l.on_open(),m=1,f.resolve(),l.heartbeat_msg&&null===g&&(h=0,g=setInterval(t,5e3))}function s(e){if(console.log("Connection closed!"),"function"==typeof l.on_close&&l.on_close(e.data),!d){var n=a(m)
d=setTimeout(function(){m++,o(u.url)},n)}}function c(e){console.error("Websocket connection is broken!"),f.reject(new Error(e)),"function"==typeof l.on_error&&l.on_error(e.data)}function i(e){if(l.heartbeat_msg&&e.data===l.heartbeat_msg)h=0
else if("function"==typeof l.receive_message)return l.receive_message(e.data)}function a(e){var n=1e3*(Math.pow(2,e)-1)
return n>3e4&&(n=3e4),Math.random()*n}var l,u,f,d,m=1,g=null,h=0
if(void 0===this)return new WS4RedisImproved(e,n)
if(void 0===e.uri)throw new Error("No Websocket URI in options")
void 0===n&&(n=jQuery),l=n.extend({heartbeat_msg:null},e),o(l.uri),this.reconnect=function(){1==u.readyState&&u.close(),o(u.url)},this.send_message=function(e){u.send(e)}}