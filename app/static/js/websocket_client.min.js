// Taken from django-websocket-redis/ws4redis/static/js/ws4redis.js
// License: MIT
function WebsocketClient(e,n){"use strict"
function o(e){console.log("connecting to "+e)
try{b=n.Deferred(),f=new WebSocket(e),f.onopen=r,f.onmessage=u,f.onerror=i,f.onclose=a,m=null}catch(o){b.reject(new Error(o))}}function t(){try{if(d++,d>3)throw c(),new Error("Too many missed heartbeats.")
console.log("sending heartbeat"),f.send(_.heartbeat_msg)}catch(e){clearInterval(h),h=null,console.warn("Closing connection. Reason: "+e.message),f.close()}}function s(){"function"==typeof _.on_heartbeat&&_.on_heartbeat()}function c(){"function"==typeof _.on_missed_heartbeat&&_.on_missed_heartbeat()}function r(){console.log("connected"),"function"==typeof _.on_open&&_.on_open(),b.resolve(),_.heartbeat_msg&&null===h&&(d=0,h=setInterval(t,5e3))}function a(e){if(console.log("connection closed"),"function"==typeof _.on_close&&_.on_close(e.data),!m){var n=l(g)
m=setTimeout(function(){g++,o(f.url)},n)}}function i(e){console.error("Websocket connection is broken!"),b.reject(new Error(e)),"function"==typeof _.on_error&&_.on_error(e.data)}function u(e){if(_.heartbeat_msg&&e.data===_.heartbeat_msg)d=0,s()
else if("function"==typeof _.receive_message)return _.receive_message(e.data)}function l(e){var n=1e3*(Math.pow(2,e)-1)
return n>3e4&&(n=3e4),Math.random()*n}var _,f,b,m,g=1,h=null,d=0
if(void 0===this)return new WebsocketClient(e,n)
if(void 0===e.uri)throw new Error("No Websocket URI in options")
void 0===n&&(n=jQuery),_=n.extend({heartbeat_msg:null},e),o(_.uri),this.reconnect=function(){g=1,m&&clearInterval(m)
try{f.close()}catch(e){console.log("could not close ws:"+e.message)}o(f.url+"&r")},this.send_message=function(e){f.send(e)}}var websocket_status=!1
jQuery(document).ready(function(e){function n(){websocket_status||(websocket_status=!0,minichat_websocket_onOpen())}function o(){websocket_status&&(websocket_status=!1,minichat_websocket_onClose())}function t(e){msg=JSON.parse(e),"app"in msg&&("minichat"==msg.app?minichat_websocket_receiveMessage(msg):"notifications"==msg.app&&notifications_websocket_receiveMessage(msg))}lexpage_websocket=WebsocketClient({uri:WEBSOCKET_URI,receive_message:t,on_heartbeat:n,on_missed_heartbeat:o,on_close:o,heartbeat_msg:WS4REDIS_HEARTBEAT})})
