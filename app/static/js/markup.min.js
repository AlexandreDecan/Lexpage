function getSelectedTextWithin(e){var t="";if("undefined"!=typeof window.getSelection){var r,a=window.getSelection();if((r=a.rangeCount)>0)for(var o,n=document.createRange(),i=0;r>i;++i)n.selectNodeContents(e),o=a.getRangeAt(i),1==o.compareBoundaryPoints(n.START_TO_END,n)&&-1==o.compareBoundaryPoints(n.END_TO_START,n)&&(1==o.compareBoundaryPoints(n.START_TO_START,n)&&n.setStart(o.startContainer,o.startOffset),-1==o.compareBoundaryPoints(n.END_TO_END,n)&&n.setEnd(o.endContainer,o.endOffset),t+=n.toString())}else if("undefined"!=typeof document.selection&&"Text"==document.selection.type){var s=document.selection.createRange(),f=s.duplicate();f.moveToElementText(e),1==s.compareEndPoints("EndToStart",f)&&-1==s.compareEndPoints("StartToEnd",f)&&(1==s.compareEndPoints("StartToStart",f)&&f.setEndPoint("StartToStart",s),-1==s.compareEndPoints("EndToEnd",f)&&f.setEndPoint("EndToEnd",s),t=f.text)}return t}function board_add_quote(e,t,r){function a(e,t){var r="[quote="+e+"]\n"+t+"\n[/quote]\n\n\n",a=new RegExp("\\[img\\](.+)\\[/img\\]","g"),o=new RegExp("\\[embed\\](.+)\\[/embed\\]","g");return r=r.replace(a,"[url]$1[/url]"),r=r.replace(o,"[url]$1[/url]")}var o=getSelectedTextWithin($("#"+e).get()[0]);$.get(t).done(function(e){r=$(r);var t;t=o.length>0?a(e.author,o):a(e.author,e.text),r.val(r.val()+t)})}function preview_markup(e,t,r){var a=t;$(r).html("<p class='text-center'><span class='fa fa-spinner fa-spin'/></p>"),$.get(e,{content:a}).done(function(e){r.html(e),refresh_oembed(r)}).fail(function(){r.html("<strong>Erreur lors du chargement de la prévisualisation.</strong>")})}function markup_proceed(e,t){t=t.get()[0];var r=t.selectionStart,a=t.selectionEnd,o=t.value,n=o.substring(0,r),i=o.substring(r,a),s=o.substring(a),f=n;e.before&&(f+=e.before),f+=i,e.after&&(f+=e.after),f+=s,t.value=f;var c;c="before"==e.cursor.position?Math.max(0,r+e.cursor.offset):Math.min(f.length,n.length+e.before.length+i.length+e.after.length-e.cursor.offset),t.selectionStart=t.selectionEnd=c,t.focus()}function get_markup_toolbar(e,t){function r(e,t){e.attr("data-toggle","tooltip"),e.attr("data-placement","top"),e.attr("title",t),e.tooltip({container:"body"})}function a(e,t,a){var o=$("<a>",{"class":"btn btn-default"});o.click({markup:t,action:a,target:e},function(e){markup_proceed(MARKUP[e.data.markup][e.data.action],e.data.target)}),r(o,MARKUP[t][a].desc+"\n"+MARKUP[t][a].syntaxe);var n;return n=MARKUP[t][a].icon?$("<span>",{"class":"fa "+MARKUP[t][a].icon}):MARKUP[t][a].label?$("<span>",{text:MARKUP[t][a].label}):$("<span>",{text:"?"}),o.append(n),o}function o(e,t,r){var o;for(inner_div=$("<div>",{"class":"btn-group btn-group-sm"}),o=0;o<r.length;o++)inner_div.append(a(e,t,r[o]));return inner_div}function n(e){for(var t=$("<div>",{"class":"smiley-popup"}),r=0;r<SMILEY_LIST.length;r++){var a=$("<a>",{"class":"btn btn-xs"});a.click({smiley:SMILEY_LIST[r],target:e},function(e){markup_proceed(get_smiley_tag(e.data.smiley),e.data.target)}),a.append($("<img>",{src:SMILEY_URL+SMILEY_LIST[r]+".gif",title:":"+SMILEY_LIST[r]+":"})),t.append(a)}return t}var i,s;if(e==BBCODE_name)s=[["bold","underline","italic","strike"],["color","font","size","align"],["quote","spoiler","code"],["url","img","embed"]];else{if(e!=MARKDOWN_name)return!1;s=[["h1","h2","h3"],["bold","italic"],["quote","code","list"],["url","image","embed"]]}i=$("<div>",{"class":"markup-toolbar btn-toolbar"});var f;for(f=0;f<s.length;f++)i.append(o(t,e,s[f]));if(e==BBCODE_name){var c=$("<div>",{"class":"btn-group btn-group-sm"}),l=$("<a>",{"class":"btn btn-default"});r(l,"Liste des smileys"),l.click({target:t},function(e){var t=e.data.target.prev(".smiley-popup").get(0);t?$(t).remove():(i=n(e.data.target),i.css("position","absolute"),e.data.target.before(i))}),l.append($("<span>",{"class":"fa fa-smile-o"})),c.append(l),i.append(c)}var c=$("<div>",{"class":"btn-group btn-group-sm"}),l=$("<a>",{"class":"btn btn-default"});l.click({target:t,markup:e},function(e){var r=e.data.target.next(".markup-preview").get(0);if(r)$(r).remove(),e.data.target.removeClass("hidden");else{var a=$("<div>",{"class":"markup-preview"});a.css("min-height",t.css("height")),a.css("max-height",t.css("height")),a.css("overflow","auto"),e.data.target.addClass("hidden"),e.data.target.after(a),preview_markup(MARKUP_URL.preview[e.data.markup],e.data.target.val(),a)}}),l.append($("<span>",{"class":"fa fa-eye"})),r(l,"Prévisualisation"),c.append(l),i.append(c);var c=$("<div>",{"class":"btn-group btn-group-sm"}),l=$("<a>",{"class":"btn btn-default"});return l.attr("href",MARKUP_URL.help[e]),r(l,"Aide sur "+e),l.attr("target","new"),l.append($("<span>",{"class":"fa fa-question"})),c.append(l),i.append(c),i}function get_suitable_quote(e,t){for(var r=-1,a=/(\[quote(=.+?)?\])|(\[\/quote\])/g,o=new Array;null!=(match=a.exec(t));){if(-1==r&&e<match.index){if(!(o.length>0))return-1;r=o[o.length-1]}if(match[0].indexOf("/")>0){if(!(o.length>0))return-1;o.pop()}else o.push(match.index)}return o.length>0?-1:r}function bbcode_quote_handler(e,t,r){if(13!=t.keyCode)return!1;e=e.get()[0];var a=e.selectionStart,o=e.value,n=get_suitable_quote(a,o);if(n>=0){if(r){var i=o.slice(n,o.indexOf("]",n)+1),s="[/quote]",f=o.substring(0,a-1),c=o.substring(a,o.length);return e.value=f+s+"\n\n\n\n"+i+c,e.selectionStart=a+s.length+1,e.selectionEnd=a+s.length+1,!1}return!0}return!1}function attach_toolbar(e,t){if(t==BBCODE_name){var r=function(t){this.lastKeyWasEnter=bbcode_quote_handler(e,t,this.lastKeyWasEnter)};$(e).keyup(r)}else if(t!=MARKDOWN_name)return!1;e.before(get_markup_toolbar(t,e))}function get_smiley_tag(e){return{before:"",after:":"+e+": ",cursor:{position:"after",offset:0}}}$(document).ready(function(){var e,t;for(t=$("textarea.markup-markdown"),e=0;e<t.length;e++)attach_toolbar($(t[e]),MARKDOWN_name);for(t=$("textarea.markup-bbcode"),e=0;e<t.length;e++)attach_toolbar($(t[e]),BBCODE_name)}),SMILEY_LIST=["angel","angel2","angry","angry2","angry3","applause","approve","asleep","bad","bat","bawling","bawling2","bigsmile","bigsmile2","blind","blush","boolay","brave","broken","bunny","clown","confused","dark","devil","disgust","door","door2","evil","fail","frightened","fuck","fuckbroken","fucklaugh","fucktongue","heart","hello","help","innocent","innocent2","innocent3","jap","juggler","kc","kc2","kiss","kiss2","kiss3","kiss4","kiss5","lol","lol2","love","mad","mad2","mad3","masturbator","metal","moaner","mocker","no","odd","old","old2","pirate","pompomgirl","poppet","puke","quiet","reproving","sad","sad2","satisfy","sex","showoff","showoff2","slave","smile","stupid","surprised","tired","tongue","tongue2","tongue3","up","upset","wall","wink","yes","yes2","yes3","yes4","yum"],SMILEY_URL=URL_PREFIX+"/static/images/smiley/",BBCODE_name="bbcode",MARKDOWN_name="markdown",MARKUP_URL={preview:{bbcode:URL_PREFIX+"/markup/bbcode/preview/",markdown:URL_PREFIX+"/markup/markdown/preview/"},help:{bbcode:URL_PREFIX+"/markup/bbcode/",markdown:URL_PREFIX+"/markup/markdown/"}},MARKUP={bbcode:{bold:{desc:"Mettre en gras",syntaxe:"[b]texte[/b]",icon:"fa-bold",before:"[b]",after:"[/b]",cursor:{position:"after",offset:4}},underline:{desc:"Souligner",syntaxe:"[u]texte[/u]",icon:"fa-underline",before:"[u]",after:"[/u]",cursor:{position:"after",offset:4}},italic:{desc:"Mettre en italique",syntaxe:"[i]texte[/i]",icon:"fa-italic",before:"[i]",after:"[/i]",cursor:{position:"after",offset:4}},strike:{desc:"Barrer",syntaxe:"[strike]texte[/strike]",icon:"fa-strikethrough",before:"[strike]",after:"[/strike]",cursor:{position:"after",offset:9}},color:{desc:"Mettre en couleur",syntaxe:"[color=red]texte[/color]",icon:"fa-flask",before:"[color=]",after:"[/color]",cursor:{position:"before",offset:7}},font:{desc:"Changer la police",syntaxe:"[font=Helvetica]texte[/font]",icon:"fa-font",before:"[font=]",after:"[/font]",cursor:{position:"before",offset:6}},size:{desc:"Changer la taille",syntaxe:"[size=12pt]texte[/size]",icon:"fa-text-height",before:"[size=]",after:"[/size]",cursor:{position:"before",offset:6}},align:{desc:"Changer l'alignement",syntaxe:"[align=center]texte[/align]",icon:"fa-align-center",before:"[align=]",after:"[/align]",cursor:{position:"before",offset:7}},url:{desc:"Lien",syntaxe:"[url]http://[/url] ou [url=http://]texte[/url]",icon:"fa-link",before:"[url]",after:"[/url]",cursor:{position:"after",offset:6}},img:{desc:"Insérer une image",syntaxe:"[img]http://[/img]",icon:"fa-picture-o",before:"[img]",after:"[/img]",cursor:{position:"after",offset:6}},embed:{desc:"Intégrer un contenu",syntaxe:"[embed]http://[/embed]",icon:"fa-video-camera",before:"[embed]",after:"[/embed]",cursor:{position:"after",offset:8}},spoiler:{desc:"Masquer le texte",syntaxe:"[spoiler]texte[/spoiler]",icon:"fa-square",before:"[spoiler]",after:"[/spoiler]",cursor:{position:"after",offset:10}},code:{desc:"Code",syntaxe:"[code]texte[/code]",icon:"fa-code",before:"[code]",after:"[/code]",cursor:{position:"after",offset:7}},quote:{desc:"Citation",syntaxe:"[quote]texte[/quote] ou [quote=auteur]texte[/quote]",icon:"fa-comment",before:"[quote]",after:"[/quote]",cursor:{position:"after",offset:8}}},markdown:{h1:{desc:"Titre 1",syntaxe:"# Titre",label:"H1",before:"# ",after:"",cursor:{position:"after",offset:0}},h2:{desc:"Titre 2",syntaxe:"## Titre",label:"H2",before:"## ",after:"",cursor:{position:"after",offset:0}},h3:{desc:"Titre 3",syntaxe:"### Titre",label:"H3",before:"### ",after:"",cursor:{position:"after",offset:0}},bold:{desc:"Mettre en gras",syntaxe:"**texte**",icon:"fa-bold",before:"**",after:"**",cursor:{position:"after",offset:2}},italic:{desc:"Mettre en italique",syntaxe:"*texte*",icon:"fa-italic",before:"*",after:"*",cursor:{position:"after",offset:1}},image:{desc:"Insérer une image",syntaxe:"![texte](http://)",icon:"fa-picture-o",before:"![](",after:")",cursor:{position:"before",offset:2}},url:{desc:"Insérer un lien",syntaxe:"[texte](http://), ou simplement <http://>",icon:"fa-link",before:"[",after:"]()",cursor:{position:"after",offset:1}},embed:{desc:"Intégrer un contenu",syntaxe:"[!embed](http://)",icon:"fa-video-camera",before:"[!embed](",after:")",cursor:{position:"after",offset:1}},quote:{desc:"Citation",syntaxe:"> ligne",icon:"fa-comment",before:"> ",after:"",cursor:{position:"after",offset:0}},code:{desc:"Code",syntaxe:"`code`, ou placer ``` sur les lignes adjacentes",icon:"fa-code",before:"```\n",after:"\n```",cursor:{position:"after",offset:4}},list:{desc:"Liste",syntaxe:"Préfixer la ligne par -",icon:"fa-list",before:" - ",after:"",cursor:{position:"after",offset:0}}}};