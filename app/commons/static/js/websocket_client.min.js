function WebsocketClient(d,f){var m,a,u,k,q=1;var t={on_message:{},on_connect:{},on_disconnect:{}};var n=null,r=0;var i=false;if(this===undefined){return new WebsocketClient(d,f)}if(f===undefined){f=jQuery}m=f.extend({heartbeat_msg:null},d);this.register=function(v,x,w){t[x][v]=w};this.isConnected=function(){return i};this.connect=function(w){try{u=f.Deferred();a=new WebSocket(w);a.onopen=j;a.onmessage=p;a.onerror=o;a.onclose=l;k=null}catch(v){u.reject(new Error(v))}};function h(){try{r++;if(r>3){c();throw new Error("Too many missed heartbeats.")}a.send(m.heartbeat_msg)}catch(v){clearInterval(n);n=null;console.warn("Closing connection. Reason: "+v.message);a.close()}}function s(x){for(var w in t[x]){var v=t[x][w];v()}}function g(){if(!i){i=true;s("on_connect")}}function c(){if(i){i=false;s("on_disconnect")}}function b(){c()}function j(){u.resolve();if(m.heartbeat_msg&&n===null){r=0;n=setInterval(h,5000)}}function l(v){if(!k){c();var w=e(q);k=setTimeout(function(){q++;this.connect(a.url)},w)}}function o(v){c();console.error("Websocket connection is broken!");u.reject(new Error(v))}function p(w){if(m.heartbeat_msg&&w.data===m.heartbeat_msg){r=0;g()}else{var y=JSON.parse(w.data);var x=y.app;if(x in t.on_message){var v=t.on_message[x];v(y)}}}function e(w){var v=(Math.pow(2,w)-1)*1000;if(v>30*1000){v=30*1000}return Math.random()*v}this.send_message=function(v){a.send(v)}};